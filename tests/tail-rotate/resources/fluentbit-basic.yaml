kind: Deployment
replicaCount: 1
rbac:
  create: true
extraVolumeMounts:
- mountPath: /var/log
  name: varlog
extraVolumes:
- name: varlog
  hostPath:
    path: /var/log

config:
  service: |
    [SERVICE]
        Flush 0.25
        Daemon Off
        Log_Level info
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port 2020
        #Parsers_File /fluent-bit/etc/parsers.conf
        Parsers_File /fluent-bit/etc/conf/custom_parsers.conf

  inputs: |
    [INPUT]
        name                      tail
        read_from_head            false
        skip_long_lines           on
        path                      /var/log/containers/noisy*_${TEST_NAMESPACE}_*.log
        #multiline.parser          docker, cri
        Tag                       kube.*
        buffer_chunk_size         2M
        buffer_max_size           2M
        Exclude_Path              /var/log/containers/*fluent*
        Refresh_Interval          1
        Key                       log
        mem_buf_limit             500MB
        threaded                  on

  filters: |
    [FILTER]
        Name   parser
        Match  kube*
        Reserve_Data True
        Parser  docker
        Parser  containerd
        Key_name log

    [FILTER]
        Name   parser
        Match  kube*
        Reserve_Data True
        Parser  glog
        Parser  json
        Key_name log

    [FILTER]
        Name modify
        Match *
        Hard_rename log message
        Copy level severity

    [FILTER]
        Name             kubernetes
        Match            kube*
        Kube_URL         https://kubernetes.default.svc:443
        Kube_CA_File     /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File  /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix  kube.var.log.containers.
        Merge_Log        Off
        Annotations      On
        Labels           On
        Buffer_Size      1MB
        Namespace_labels On
        kube_meta_namespace_cache_ttl 5m

    [FILTER]
        Name nest
        Match kube*
        Operation lift
        Nested_under kubernetes
        Add_prefix kubernetesmeta_

    [FILTER]
        Name  modify
        Alias remove_unused_k8s_meta
        Match kube*
        Remove_regex kubernetesmeta_(?!labels)
        Remove_regex kubernetes_namespace

  outputs: |
    [OUTPUT]
        Name counter
        Match *

  customParsers: |
    [PARSER]
        Name        docker
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    [PARSER]
        Name        containerd
        Format      regex
        Regex       ^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    [PARSER]
        Name        json
        Format      json

    [PARSER]
        Name        syslog
        Format      regex
        Regex       ^\<(?<pri>[0-9]+)\>(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
        Time_Key    time
        Time_Format %b %d %H:%M:%S

    [PARSER]
        Name        glog
        Format      regex
        Regex       ^(?<severity>\w)(?<time>\d{4} [^\s]*)\s+(?<pid>\d+)\s+(?<source_file>[^ \]]+)\:(?<source_line>\d+)\]\s(?<message>.*)$
        Time_Key    time
        Time_Format %m%d %H:%M:%S.%L

    [PARSER]
        Name        network-log
        Format      json
        Time_Key    timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z